<!-- discovery_form.html -->
<!-- Copyright (c) 2025 <Tretyakov Vyacheslav>
See README.md file in the project root for full license information. -->

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Information Discovery</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      .collapsible-header { 
        font-size: 1.2rem; 
        display: flex;
        align-items: center;
        width: 100%; /* Ensure it tries to use full available width */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
      }
      .collapsible-header > span { /* Apply to all direct span children */
        padding-right: 15px; /* Default spacing between items */
        white-space: nowrap;
        text-align: left;
      }
      .collapsible-header .name-column {
        /* width: 220px; /* Let's try without fixed width for a moment, or a min-width */
        min-width: 200px; /* Ensure it has at least this much space */
        /* flex-shrink: 0; /* Prevent this column from shrinking too much */
      }
      .collapsible-header .vendor-column {
        min-width: 80px;
        color: #666;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .collapsible-header .vendor-column:hover {
        color: #26a69a;
        transform: scale(1.05);
      }
      .collapsible-header .role-column {
        /* width: 250px; /* Increased width significantly */ 
        min-width: 250px; /* Give it more minimum space */
        cursor: pointer;
        transition: all 0.3s ease;
        /* No overflow or ellipsis, allow it to take space */
        /* flex-shrink: 0; */
      }
      .collapsible-header .role-column:hover {
        color: #26a69a;
        transform: scale(1.05);
      }
      .collapsible-header .status-column {
        min-width: 90px;
        /* flex-shrink: 0; */
      }
      .collapsible-header .subscription-column {
        min-width: 145px; 
        /* flex-shrink: 0; */
      }
      .collapsible-header .update-info-column {
        margin-left: auto; /* This is key to push it to the right */
        display: flex;       /* Keep its internal items aligned */
        align-items: center; 
        white-space: nowrap; /* Keep "Дата обновления..." on one line */
        text-align: right;
        padding-left: 15px; /* Space before the date text */
        /* flex-shrink: 0; /* Don't let the update info shrink */
      }
      .update-icon {
        cursor: pointer;
        margin-left: 8px; /* More space before icon */
        vertical-align: middle;
      }
      .capacity-info {
        font-style: italic;
        color: #555;
        margin-bottom: 10px;
      }
      .vendor-credentials {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin: 15px 0;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      .vendor-group {
        flex: 1;
        min-width: 200px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 4px;
        background-color: white;
      }
      .vendor-group h6 {
        margin: 0 0 10px 0;
        color: #26a69a;
        font-weight: bold;
      }
      .vendor-input {
        width: 100%;
        padding: 5px 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 13px;
      }
      
      /* Sorting controls */
      .sorting-controls {
        margin: 15px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }
      
      .sort-btn {
        background-color: #6c757d !important;
        margin: 0 5px 5px 0;
        padding: 8px 12px !important;
        font-size: 12px !important;
        height: auto !important;
        line-height: 1.2 !important;
      }
      
      .sort-btn.active {
        background-color: #26a69a !important;
      }
      
      .sort-btn:hover {
        background-color: #5a6268 !important;
      }
      
      .sort-btn.active:hover {
        background-color: #1e8e7e !important;
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-wrapper">
        <a href="#" class="brand-logo center">Storage Info</a>
      </div>
    </nav>
    <div class="container" style="margin-top: 30px;">
      
      <!-- Спойлер для поиска -->
      <details class="search-spoiler">
        <summary class="search-summary">
          <h5>Поиск по Initiator IQN или LUN WWN</h5>
        </summary>
        <div class="search-content">
          <form method="get" action="{{ url_for('discovery_form') }}" id="search-form">
            <input type="hidden" name="table_filter" value="{{ table_filter }}">
            <div class="search-controls">
              <div class="search-input-group">
                <label for="search_query">Поиск по Initiator IQN или LUN WWN</label>
                <input type="text" name="search_query" id="search_query" value="{{ iqn_search or wwn_search }}" class="search-input">
              </div>
              <div class="search-options-group">
                <label class="search-checkbox-label">
                  <input type="checkbox" name="search_all" {% if request.args.get('search_all') == 'on' %}checked{% endif %} class="filled-in">
                  <span>Поиск по всем площадкам</span>
                </label>
                <button class="btn waves-effect waves-light search-btn" type="submit">
                  ПОИСК
                </button>
              </div>
            </div>
            <div id="search-progress" class="progress" style="display: none; margin-top: 20px;">
              <div class="indeterminate"></div>
            </div>
            <div id="search-progress-text" style="display: none;">
              Выполняется поиск IQN/WWN...
            </div>
          </form>
        </div>
      </details>
      <br>

      {% if error_message %}
        <div class="card-panel red lighten-2">{{ error_message }}</div>
      {% endif %}

      <!-- Панель управления - кнопки действий -->
      <div class="action-buttons-panel">
        <button class="btn waves-effect waves-light action-btn" id="show-discovery-modal">
          ОБНОВИТЬ ИНФОРМАЦИЮ ПО ПЛОЩАДКЕ
        </button>

        {% if sorted_storage %}
          <form id="excel-form" method="post" action="{{ url_for('download_excel') }}" style="display: inline-block;">
            <input type="hidden" name="table_filter" value="{{ table_filter }}">
            <button class="btn waves-effect waves-light action-btn" type="submit">
              ВЫГРУЗИТЬ В EXCEL
            </button>
          </form>
        {% endif %}

        <a class="btn waves-effect waves-light action-btn" href="{{ url_for('storage_form', table_filter=table_filter) }}">
          ВЕРНУТЬСЯ НА СТРАНИЦУ ВЫБОРА ПЛОЩАДКИ
        </a>
      </div>

      <!-- Прогресс-бары вынесены из панели -->
      <div class="progress-container">
        <div id="excel-progress" class="progress" style="display: none;">
          <div class="indeterminate"></div>
        </div>
        <div id="excel-progress-text" style="display: none;">
          Сохранение файла...
        </div>
        
        <div id="progress-all" class="progress" style="display: none;">
          <div class="indeterminate"></div>
        </div>
        <div id="progress-text-all" style="display: none;">
          Выполняется поиск и обновление информации по площадке...
        </div>
      </div>

      {% if sorted_storage %}
        <!-- Sorting Controls -->
        <div class="sorting-controls">
          <span style="font-weight: bold; margin-right: 10px;">Сортировка:</span>
          <button class="btn sort-btn" id="sort-default">По умолчанию</button>
          <button class="btn sort-btn" id="sort-vendor">По вендору</button>
          <button class="btn sort-btn" id="sort-role">По роли</button>
          <button class="btn sort-btn" id="sort-name">По имени</button>
        </div>

        <ul class="collapsible" id="storage-list">
          {% for storage_name, data in sorted_storage %}
            <li data-vendor="{{ data.vendor or 'Unknown' }}" data-role="{{ data.storage_role or 'Unknown' }}" data-name="{{ storage_name }}">
              <div class="collapsible-header">
                <span class="name-column" style="color: {{ data.color if data.color else 'grey' }};">[{{ storage_name }}]</span>
                <span class="vendor-column" data-sort="vendor">[{{ data.vendor or 'Unknown' }}]</span>
                <span class="role-column" data-sort="role">[{{ data.storage_role or 'Unknown' }}]</span>
                <span class="status-column">[{{ data.storage_status or 'Не указано' }}]</span>
                <span class="subscription-column">
                  {% if data.subscription_ratio is defined and data.subscription_ratio != 'N/A' %}
                    [Подписка: {{ data.subscription_ratio }}%]
                  {% elif data.total_effective_tb is defined and data.total_effective_tb == 0 and data.pools|length > 0 %}
                    [Подписка: Ошибка]
                  {% elif data.total_effective_tb is defined and data.total_effective_tb > 0 and data.pools|length == 0 %}
                     [Подписка: 0.00%]
                  {% else %}
                    [Подписка: Н/Д]
                  {% endif %}
                </span>
                <span class="update-info-column">
                  {% if data.last_updated %}
                    Дата обновления: 
                    {% if data.last_updated is string %}
                        {{ data.last_updated.split('.')[0] }}
                    {% else %}
                        {{ data.last_updated|moscow_time }}
                    {% endif %}
                  {% else %}
                    Дата обновления: Не обновлялось
                  {% endif %}
                  <img src="{{ url_for('static', filename='images/refresh-30.png') }}" alt="Обновить" class="update-icon" data-table-name="{{ table_filter }}" data-storage-name="{{ storage_name }}" onclick="handleRefreshClick(this, '{{ table_filter }}', '{{ storage_name }}')" />
                </span>
              </div>
              <div class="collapsible-body">
                {% if data.ip_address %}
                  {% if data.vendor == 'Huawei' %}
                    <a class="btn waves-effect waves-light" href="https://{{ data.ip_address }}:8088" target="_blank" style="margin-bottom: 20px;">
                      ПЕРЕЙТИ К УПРАВЛЕНИЮ СХД HUAWEI
                    </a>
                  {% elif data.vendor == 'NetApp' %}
                    <a class="btn waves-effect waves-light" href="https://{{ data.ip_address }}" target="_blank" style="margin-bottom: 20px;">
                      ПЕРЕЙТИ К УПРАВЛЕНИЮ СХД NETAPP
                    </a>
                  {% elif data.vendor == 'IBM' %}
                    <a class="btn waves-effect waves-light" href="https://{{ data.ip_address }}:7443" target="_blank" style="margin-bottom: 20px;">
                      ПЕРЕЙТИ К УПРАВЛЕНИЮ СХД IBM
                    </a>
                  {% else %}
                    <a class="btn waves-effect waves-light" href="https://{{ data.ip_address }}" target="_blank" style="margin-bottom: 20px;">
                      ПЕРЕЙТИ К УПРАВЛЕНИЮ СХД
                    </a>
                  {% endif %}
                {% endif %}

                {% if data.vendor == 'NetApp' %}
                  <h5>Агрегаты хранения</h5>
                {% elif data.vendor == 'IBM' %}
                  <h5>Пулы хранения (MDisk Groups)</h5>
                {% else %}
                  <h5>Пулы хранения</h5>
                {% endif %}
                
                {% if data.vendor != 'NetApp' %}
                  <div class="capacity-info">
                    Общая эффективная емкость СХД: 
                    <strong>{{ data.total_effective_tb if data.total_effective_tb is defined else 'Н/Д' }} TiB</strong>.
                    Суммарная подписка по пулам: 
                    <strong>{{ data.sum_subscribed_capacity_tb if data.sum_subscribed_capacity_tb is defined else 'Н/Д' }} TiB</strong>.
                  </div>
                {% endif %}
                
                {% if data.pools|length > 0 %}
                  <table class="responsive-table">
                    <thead>
                      <tr>
                        {% if data.vendor == 'NetApp' %}
                          <th>Имя агрегата</th>
                          <th>Общий размер (TiB)</th>
                          <th>Используется (TiB)</th>
                          <th>Доступно (TiB)</th>
                          <th>Подписка томами (TiB)</th>
                        {% elif data.vendor == 'IBM' %}
                          <th>Имя пула</th>
                          <th>Емкость (TiB)</th>
                          <th>Используется (TiB)</th>
                          <th>Свободно (TiB)</th>
                          <th>Подписка томами (TiB)</th>
                        {% else %}
                          <th>Имя пула</th>
                          <th>Dataspace (TiB)</th>
                          <th>Используется (TiB)</th>
                          <th>Свободно (TiB)</th>
                          <th>Subscribed Capacity (TiB)</th>
                        {% endif %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for pool in data.pools %}
                        <tr>
                            {# вычисляем класс строки только для NetApp #}
                            {% set row_class = '' %}
                            {% if data.vendor == 'NetApp' %}
                              {% set row_class = 'aggregate-group-' ~ (data.aggregate_color_map[pool.pool_name] if pool.pool_name in data.aggregate_color_map else 0) %}
                            {% endif %}
                          <tr class="{{ row_class }}">
                          <td>{{ pool.pool_name }}</td>
                          <td>{{ pool.dataspace }}</td>
                          <td>{{ pool.used_capacity if pool.used_capacity is defined else 'Н/Д' }}</td>
                          <td>{{ pool.free_capacity if pool.free_capacity is defined else 'Н/Д' }}</td>
                          <td>{{ pool.subscribed_capacity }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <p>Пулы не найдены.</p>
                {% endif %}

                {% if data.vendor == 'NetApp' %}
                  <h5>Тома ({{ data.luns|length }})</h5>
                  {% if data.luns|length > 0 %}
                    <table class="responsive-table">
                      <thead>
                        <tr>
                          <th>Имя</th>
                          <th>SVM</th>
                          <th>Агрегат</th>
                          <th>Размер (TiB)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for lun in data.luns %}
                          {% set row_class = 'aggregate-group-' ~ (data.aggregate_color_map[lun.aggregate] if lun.aggregate in data.aggregate_color_map else 0) %}
                          <tr class="{{ row_class }}">
                            <td>{{ lun.name }}</td>
                            <td>{{ lun.svm }}</td>
                            <td>{{ lun.aggregate }}</td>
                            <td>{{ "%.2f"|format(lun.size|float) }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p>Тома не найдены.</p>
                  {% endif %}
                {% endif %}

                {% if data.vendor == 'NetApp' %}
                  <h5>SVM ({{ data.initiators|length }})</h5>
                {% elif data.vendor == 'IBM' %}
                  <h5>Хосты ({{ data.initiators|length }})</h5>
                {% else %}
                  <h5>Инициаторы ({{ data.initiators|length }})</h5>
                {% endif %}
                
                {% if data.initiators|length > 0 %}
                  <table class="responsive-table initiators-table" data-storage="{{ storage_name | replace(' ', '_') }}">
                    <thead>
                      <tr>
                        {% if data.vendor == 'NetApp' %}
                          <th>Имя SVM</th>
                          <th>UUID</th>
                          <th>Тип</th>
                          <th>Состояние</th>
                        {% elif data.vendor == 'IBM' %}
                          <th>IQN</th>
                          <th class="sortable" data-sort="host_name">Имя хоста</th>
                          <th class="sortable" data-sort="status">Статус</th>
                          <th>Host IP</th>
                        {% else %}
                          <th>IQN</th>
                          <th class="sortable" data-sort="host_name">Host_Name</th>
                          <th class="sortable" data-sort="status">Status</th>
                          <th>Host IP</th>
                        {% endif %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for init in data.initiators %}
                        <tr>
                          {% if data.vendor == 'NetApp' %}
                            <td>{{ init.name if init.name is defined else 'Н/Д' }}</td>
                            <td>{{ init.uuid if init.uuid is defined else 'Н/Д' }}</td>
                            <td>{{ init.type if init.type is defined else 'Н/Д' }}</td>
                            <td>{{ init.state if init.state is defined else 'Н/Д' }}</td>
                          {% else %}
                            <td>{{ init.iqn }}</td>
                            <td>{{ init.host_name }}</td>
                            <td>
                              <span style="color: {% if init.init_status == 'Offline' %}red{% else %}green{% endif %}">
                                {{ init.init_status }}
                              </span>
                            </td>
                            <td>{{ init.hostIP }}</td>
                          {% endif %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  {% if data.vendor == 'NetApp' %}
                    <p>SVM не найдены.</p>
                  {% elif data.vendor == 'IBM' %}
                    <p>Хосты не найдены.</p>
                  {% else %}
                    <p>Инициаторы не найдены.</p>
                  {% endif %}
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Нет сохранённых данных для данной площадки (или поиск не дал результатов).</p>
      {% endif %}

      <!-- Modal Structure for site-wide discovery -->
      <div id="discovery-modal" class="modal modal-fixed-footer">
        <div class="modal-content">
          <h4>Обновление данных по площадке {{ table_filter }}</h4>
          <form id="discovery-form" method="post">
            <input type="hidden" name="action" value="do_discovery">
            <input type="hidden" name="table_filter" value="{{ table_filter }}">
            
            <div class="vendor-credentials">
              <!-- Huawei credentials -->
              <div class="vendor-group">
                <h6>Huawei Dorado</h6>
                <input type="text" name="huawei_username" class="vendor-input" placeholder="Логин Huawei" value="{{ last_huawei_username or '' }}">
                <input type="password" name="huawei_password" class="vendor-input" placeholder="Пароль Huawei" value="{{ last_huawei_password or '' }}">
              </div>
              
              <!-- NetApp credentials -->
              <div class="vendor-group">
                <h6>NetApp ONTAP</h6>
                <input type="text" name="netapp_username" class="vendor-input" placeholder="Логин NetApp" value="{{ last_netapp_username or '' }}">
                <input type="password" name="netapp_password" class="vendor-input" placeholder="Пароль NetApp" value="{{ last_netapp_password or '' }}">
              </div>
              
              <!-- IBM credentials -->
              <div class="vendor-group">
                <h6>IBM FlashSystem</h6>
                <input type="text" name="ibm_username" class="vendor-input" placeholder="Логин IBM" value="{{ last_ibm_username or '' }}">
                <input type="password" name="ibm_password" class="vendor-input" placeholder="Пароль IBM" value="{{ last_ibm_password or '' }}">
              </div>
            </div>
            
            <button class="btn waves-effect waves-light" type="submit">ВЫПОЛНИТЬ ОБНОВЛЕНИЕ ДАННЫХ ПО ПЛОЩАДКЕ</button>
          </form>
        </div>
        <div class="modal-footer">
          <a href="#!" class="modal-close waves-effect waves-green btn-flat">Отмена</a>
        </div>
      </div>

      <!-- Modal Structure for single storage update -->
      <div id="update-modal" class="modal modal-fixed-footer">
        <div class="modal-content">
          <h4>Обновить систему хранения <span id="modal-storage-name"></span></h4>
          <form id="update-single-form" method="post" action=""> <!-- action will be set by JS -->
            <input type="hidden" id="modal_table_name" name="table_name">
            <input type="hidden" id="modal_storage_name_hidden" name="storage_name">
            <input type="hidden" id="modal_vendor" name="vendor">
            
            <div id="credentials-container">
              <!-- Credentials will be populated by JavaScript based on vendor -->
            </div>
            
            <button class="btn waves-effect waves-light" type="submit">ВЫПОЛНИТЬ DISCOVERY ДЛЯ СХД</button>
            <div id="progress-single" class="progress" style="display: none; margin-top: 20px;">
              <div class="indeterminate"></div>
            </div>
            <div id="progress-text-single" style="display: none;">
              Обновление данных для <span id="progress-single-storage-name"></span>...
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <a href="#!" class="modal-close waves-effect waves-green btn-flat">Отмена</a>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.collapsible');
        M.Collapsible.init(elems, {});

        var modals = document.querySelectorAll('.modal');
        M.Modal.init(modals, {});

        // Sorting functionality
        let currentSort = 'default';
        
        function getVendorPriority(vendor) {
          const priorities = { 'NetApp': 1, 'Huawei': 2, 'IBM': 3 };
          return priorities[vendor] || 999;
        }
        
        function getRolePriority(role) {
          const priorities = {
            'Storage Management': 1,
            'Storage': 2,
            'Storage Baremetal Public': 3,
            'Storage VMware Public': 4,
            'Storage VMware Private': 5,
            'Storage VMware Public Sber': 6,
            'Storage VMware Public DR Sber': 7
          };
          return priorities[role] || 999;
        }
        
        function sortStorageList(sortBy) {
          const storageList = document.getElementById('storage-list');
          const items = Array.from(storageList.children);
          
          // Clear vendor border classes first
          items.forEach(item => {
            item.classList.remove('vendor-netapp', 'vendor-huawei', 'vendor-ibm', 'vendor-unknown');
          });
          
          items.sort((a, b) => {
            const vendorA = a.dataset.vendor;
            const vendorB = b.dataset.vendor;
            const roleA = a.dataset.role;
            const roleB = b.dataset.role;
            const nameA = a.dataset.name;
            const nameB = b.dataset.name;
            
            switch(sortBy) {
              case 'vendor':
                const vendorCompare = getVendorPriority(vendorA) - getVendorPriority(vendorB);
                if (vendorCompare !== 0) return vendorCompare;
                return nameA.localeCompare(nameB);
                
              case 'role':
                const roleCompare = getRolePriority(roleA) - getRolePriority(roleB);
                if (roleCompare !== 0) return roleCompare;
                return nameA.localeCompare(nameB);
                
              case 'name':
                return nameA.localeCompare(nameB);
                
              default: // original order
                return 0;
            }
          });
          
          // Reorder DOM elements
          items.forEach(item => storageList.appendChild(item));
          
          // Add vendor border classes when sorting by vendor
          if (sortBy === 'vendor') {
            items.forEach(item => {
              const vendor = item.dataset.vendor.toLowerCase();
              item.classList.add(`vendor-${vendor}`);
            });
          }
          
          // Update active button
          document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
          document.getElementById(`sort-${sortBy}`).classList.add('active');
          
          currentSort = sortBy;
        }
        
        // Sort button event listeners
        document.getElementById('sort-default').addEventListener('click', () => sortStorageList('default'));
        document.getElementById('sort-vendor').addEventListener('click', () => sortStorageList('vendor'));
        document.getElementById('sort-role').addEventListener('click', () => sortStorageList('role'));
        document.getElementById('sort-name').addEventListener('click', () => sortStorageList('name'));
        
        // Set default active button
        document.getElementById('sort-default').classList.add('active');

        window.handleRefreshClick = function(icon, tableName, storageName) {
          icon.classList.add('clicked');
          setTimeout(() => icon.classList.remove('clicked'), 200);

          // Получаем vendor из данных на странице
          let vendor = 'Huawei'; // default
          let storageHeader = icon.closest('.collapsible-header');
          if (storageHeader) {
            let vendorSpan = storageHeader.querySelector('.vendor-column');
            if (vendorSpan) {
              vendor = vendorSpan.textContent.replace(/[\[\]]/g, '').trim();
            }
          }

          var form = document.getElementById('update-single-form');
          form.action = `/update_storage/${tableName}/${storageName}`;
          document.getElementById('modal_table_name').value = tableName;
          document.getElementById('modal_storage_name_hidden').value = storageName;
          document.getElementById('modal_vendor').value = vendor;
          document.getElementById('modal-storage-name').textContent = storageName;
          document.getElementById('progress-single-storage-name').textContent = storageName;
          
          // Populate credentials based on vendor
          let credentialsHtml = '';
          if (vendor === 'Huawei') {
            credentialsHtml = `
              <div class="input-field">
                <input id="modal_username" type="text" name="username" required>
                <label for="modal_username">Логин для Huawei API</label>
              </div>
              <div class="input-field">
                <input id="modal_password" type="password" name="password" required>
                <label for="modal_password">Пароль для Huawei API</label>
              </div>`;
          } else if (vendor === 'NetApp') {
            credentialsHtml = `
              <div class="input-field">
                <input id="modal_username" type="text" name="username" required>
                <label for="modal_username">Логин для NetApp ONTAP API</label>
              </div>
              <div class="input-field">
                <input id="modal_password" type="password" name="password" required>
                <label for="modal_password">Пароль для NetApp ONTAP API</label>
              </div>`;
          } else if (vendor === 'IBM') {
            credentialsHtml = `
              <div class="input-field">
                <input id="modal_username" type="text" name="username" required>
                <label for="modal_username">Логин для IBM FlashSystem API</label>
              </div>
              <div class="input-field">
                <input id="modal_password" type="password" name="password" required>
                <label for="modal_password">Пароль для IBM FlashSystem API</label>
              </div>`;
          }
          
          document.getElementById('credentials-container').innerHTML = credentialsHtml;
          M.updateTextFields();

          var instance = M.Modal.getInstance(document.getElementById('update-modal'));
          instance.open();
        };

        document.getElementById('update-single-form').addEventListener('submit', function(e) {
          document.getElementById('progress-single').style.display = 'block';
          document.getElementById('progress-text-single').style.display = 'block';
        });
        
        var searchForm = document.getElementById("search-form");
        if (searchForm) {
          searchForm.addEventListener("submit", function() {
            document.getElementById("search-progress").style.display = "block";
            document.getElementById("search-progress-text").style.display = "block";
          });
        }

        var discoveryForm = document.getElementById("discovery-form");
        if(discoveryForm) {
          discoveryForm.addEventListener("submit", function() {
            // Close modal and show progress
            var modalInstance = M.Modal.getInstance(document.getElementById('discovery-modal'));
            modalInstance.close();
            document.getElementById("progress-all").style.display = "block";
            document.getElementById("progress-text-all").style.display = "block";
          });
        }

        // Show discovery modal
        var showDiscoveryModalBtn = document.getElementById('show-discovery-modal');
        if(showDiscoveryModalBtn) {
          showDiscoveryModalBtn.addEventListener('click', function() {
            var modalInstance = M.Modal.getInstance(document.getElementById('discovery-modal'));
            modalInstance.open();
          });
        }

        var excelForm = document.getElementById("excel-form");
        if(excelForm) {
          excelForm.addEventListener("submit", function() {
            document.getElementById("excel-progress").style.display = "block";
            document.getElementById("excel-progress-text").style.display = "block";
          });
        }

        // Sorting for initiators table
        document.querySelectorAll('.initiators-table').forEach(table => {
          const tbody = table.querySelector('tbody');
          const headers = table.querySelectorAll('.sortable');

          headers.forEach(header => {
            header.addEventListener('click', () => {
              const sortKey = header.getAttribute('data-sort');
              const rows = Array.from(tbody.querySelectorAll('tr'));
              const isAscending = header.classList.contains('asc');

              headers.forEach(h => h.classList.remove('asc', 'desc'));
              header.classList.add(isAscending ? 'desc' : 'asc');

              rows.sort((a, b) => {
                let aValue, bValue;
                if (sortKey === 'host_name') {
                  aValue = a.cells[1].textContent.trim().toLowerCase();
                  bValue = b.cells[1].textContent.trim().toLowerCase();
                } else if (sortKey === 'status') {
                  aValue = a.cells[2].textContent.trim().toLowerCase();
                  bValue = b.cells[2].textContent.trim().toLowerCase();
                  // online < offline for ascending
                  if (aValue === 'online' && bValue === 'offline') return isAscending ? 1 : -1;
                  if (aValue === 'offline' && bValue === 'online') return isAscending ? -1 : 1;
                  return 0;
                }

                if (isAscending) {
                  return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                } else {
                  return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                }
              });
              rows.forEach(row => tbody.appendChild(row));
            });
          });
        });
      });
    </script>
  </body>
</html>